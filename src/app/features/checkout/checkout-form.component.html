<div class="max-w-7xl mx-auto p-5">
  @if (isOrderComplete()) {
    <mat-card class="max-w-lg mx-auto my-12 text-center">
      <mat-card-header>
        <mat-card-title class="flex items-center justify-center gap-2">
          <mat-icon color="primary" class="text-8xl w-8 h-8 animate-pulse">check_circle</mat-icon>
          Order Complete!
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>Thank you for your purchase! Your order has been successfully placed.</p>
        <p>You will be redirected to the products page shortly...</p>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
      <!-- Order Summary -->
      <mat-card class="sticky top-5 lg:order-1 order-2">
        <mat-card-header>
          <mat-card-title>Order Summary</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @for (item of cartItems(); track item.product.id) {
            <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
              <span class="flex-1 font-medium">{{ item.product.name }}</span>
              <span class="mx-4 text-gray-600 text-sm">x{{ item.quantity }}</span>
              <span class="font-semibold text-blue-600">{{ item.product.price * item.quantity | currency }}</span>
            </div>
          }
          <mat-divider></mat-divider>
          <div class="text-right text-xl text-blue-600 py-2">
            <strong>Total: {{ totalPrice() | currency }}</strong>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Checkout Form -->
      <mat-card class="lg:col-span-2 lg:order-2 order-1">
        <mat-card-content>
          <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">
            <!-- Customer Information -->
            <div class="mb-8" formGroupName="customerInfo">
              <h3 class="mb-5 text-gray-800 font-medium text-lg">Customer Information</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>First Name</mat-label>
                  <input matInput formControlName="firstName" required>
                  @if (checkoutForm.get('customerInfo.firstName')?.invalid && checkoutForm.get('customerInfo.firstName')?.touched) {
                    <mat-error>First name is required (min 2 characters)</mat-error>
                  }
                </mat-form-field>
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Last Name</mat-label>
                  <input matInput formControlName="lastName" required>
                  @if (checkoutForm.get('customerInfo.lastName')?.invalid && checkoutForm.get('customerInfo.lastName')?.touched) {
                    <mat-error>Last name is required (min 2 characters)</mat-error>
                  }
                </mat-form-field>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Email</mat-label>
                  <input matInput type="email" formControlName="email" required>
                  @if (checkoutForm.get('customerInfo.email')?.invalid && checkoutForm.get('customerInfo.email')?.touched) {
                    <mat-error>Please enter a valid email address</mat-error>
                  }
                </mat-form-field>
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Phone</mat-label>
                  <input matInput formControlName="phone" appMask="000-000-000" dropSpecialCharacters required>
                  @if (checkoutForm.get('customerInfo.phone')?.invalid && checkoutForm.get('customerInfo.phone')?.touched) {
                    <mat-error>Please enter a valid phone number</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>

            <mat-divider></mat-divider>

            <!-- Shipping Address -->
            <div class="mb-4 mt-8" formGroupName="shippingAddress">
              <h3 class="mb-5 text-gray-800 font-medium text-lg">Shipping Address</h3>
              <mat-form-field appearance="outline" class="w-full mb-4">
                <mat-label>Street Address</mat-label>
                <input matInput formControlName="street" required>
                @if (checkoutForm.get('shippingAddress.street')?.invalid && checkoutForm.get('shippingAddress.street')?.touched) {
                  <mat-error>Street address is required</mat-error>
                }
              </mat-form-field>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>City</mat-label>
                  <input matInput formControlName="city" required>
                  @if (checkoutForm.get('shippingAddress.city')?.invalid && checkoutForm.get('shippingAddress.city')?.touched) {
                    <mat-error>City is required</mat-error>
                  }
                </mat-form-field>
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>State</mat-label>
                  <input matInput formControlName="state" required>
                  @if (checkoutForm.get('shippingAddress.state')?.invalid && checkoutForm.get('shippingAddress.state')?.touched) {
                    <mat-error>State is required</mat-error>
                  }
                </mat-form-field>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>ZIP Code</mat-label>
                  <input matInput formControlName="zipCode" placeholder="00-000" appMask="00-000" required>
                  @if (checkoutForm.get('shippingAddress.zipCode')?.invalid && checkoutForm.get('shippingAddress.zipCode')?.touched) {
                    <mat-error>Please enter a valid ZIP code</mat-error>
                  }
                </mat-form-field>
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Country</mat-label>
                  <input matInput formControlName="country" required>
                  @if (checkoutForm.get('shippingAddress.country')?.invalid && checkoutForm.get('shippingAddress.country')?.touched) {
                    <mat-error>Country is required</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>

            <mat-divider></mat-divider>

            <!-- Payment Information -->
            <div class="mb-4 mt-8" formGroupName="paymentInfo">
              <h3 class="mb-5 text-gray-800 font-medium text-lg">Payment Information</h3>
              <mat-form-field appearance="outline" class="w-full mb-4">
                <mat-label>Cardholder Name</mat-label>
                <input matInput formControlName="cardholderName" required>
                @if (checkoutForm.get('paymentInfo.cardholderName')?.invalid && checkoutForm.get('paymentInfo.cardholderName')?.touched) {
                  <mat-error>Cardholder name is required</mat-error>
                }
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full mb-4">
                <mat-label>Card Number</mat-label>
                <input
                  matInput formControlName="cardNumber" placeholder="0000 0000 0000 0000"
                  appMask="0000 0000 0000 0000" dropSpecialCharacters required
                >
                @if (checkoutForm.get('paymentInfo.cardNumber')?.invalid && checkoutForm.get('paymentInfo.cardNumber')?.touched) {
                  <mat-error>Please enter a valid 16-digit card number</mat-error>
                }
              </mat-form-field>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Expiry Date</mat-label>
                  <input matInput formControlName="expiryDate" placeholder="MM/YY" appMask="00/00" required>
                  @if (checkoutForm.get('paymentInfo.expiryDate')?.invalid && checkoutForm.get('paymentInfo.expiryDate')?.touched) {
                    <mat-error>Please enter expiry date (MM/YY)</mat-error>
                  }
                </mat-form-field>
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>CVV</mat-label>
                  <input matInput formControlName="cvv" placeholder="123" appMask="000" required>
                  @if (checkoutForm.get('paymentInfo.cvv')?.invalid && checkoutForm.get('paymentInfo.cvv')?.touched) {
                    <mat-error>Please enter a valid CVV</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="flex flex-col-reverse sm:flex-row justify-between items-center mt-8 gap-4">
              <button
                mat-button type="button" (click)="goBackToCart()"
                class="flex items-center gap-2 text-gray-600 w-full sm:w-auto"
              >
                <mat-icon>arrow_back</mat-icon>
                Back to Cart
              </button>
              <button
                mat-flat-button
                color="primary"
                type="submit"
                [disabled]="isSubmitting()"
              >
                <div class="flex items-center gap-2 w-full sm:w-auto">
                  @if (isSubmitting()) {
                    <mat-icon class="animate-spin">hourglass_empty</mat-icon>
                    Processing...
                  } @else {
                    <mat-icon>payment</mat-icon>
                    Complete Order
                  }
                </div>
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  }
</div>
